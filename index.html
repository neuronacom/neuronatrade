<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>NEURONA Trade AI Bot</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#fff">
  <link rel="icon" type="image/png" href="https://i.ibb.co/XfKRzvcy/27.png">
  <style>
    html, body { background: #fff; color: #000; width: 100vw; height: 100vh; margin: 0; padding: 0; font-family: Arial, 'Segoe UI', sans-serif; overflow: hidden; }
    .top-bar { position: fixed; top: 0; left: 0; width: 100vw; height: 54px; display: flex; align-items: center; justify-content: flex-start; background: #fff; z-index: 11; box-shadow: 0 2px 16px #0001; }
    .top-logo { width: 35px; height: 35px; margin: 0 13px 0 16px; border-radius: 8px; background: #fff; }
    .top-title { font-size: 1.52rem; letter-spacing: .11em; font-weight: bold; color: #111; user-select: none; line-height: 1; text-transform: uppercase; }
    .top-sub { font-size: 0.84em; color: #555; display: block; line-height: 1.0; font-weight: 500; margin-top: 2px; margin-left: 2px; letter-spacing: .04em; }
    .refresh-btn { margin-left: auto; margin-right: 16px; background: none; border: none; outline: none; cursor: pointer; display: flex; align-items: center; padding: 7px; border-radius: 50%; box-shadow: 0 1.5px 7px #0001; transition: background .15s; }
    .refresh-btn svg { width: 32px; height: 32px; stroke: #181818; }
    .refresh-btn:hover { background: #eee; }
    #app { width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: none; margin-top: 54px; }
    .chat-container { width: 100%; max-width: 370px; min-width: 220px; height: 75vh; margin: 0 auto; margin-top: 44px; background: rgba(255,255,255,0.97); border-radius: 16px; box-shadow: 0 8px 32px #0001, 0 2px 7px #0002; border: 1.5px solid #e1e1e1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
    #messages { flex: 1; overflow-y: auto; padding: 18px 13px 10px 13px; box-sizing: border-box; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
    .message { background: #e6eaf7; color: #222; padding: 12px 14px; border-radius: 12px 14px 14px 4px; max-width: 85%; min-width: 70px; box-shadow: 0 1.2px 4px #bbb2; font-size: 1rem; line-height: 1.54; align-self: flex-start; position: relative; word-break: break-word; border: 1px solid #dde1ed; }
    .message.long { background: #e6fbe6; color: #116610; border-color: #bcf3c6; font-weight: bold;}
    .message.short { background: #fbe6e6; color: #bb191b; border-color: #f4bbbb; font-weight: bold;}
    .message.news { background: #fffbe8; color: #b38000; border-color: #ffeebb; }
    .message.typing { font-style: italic; color: #666; background: #f4f4f4; min-width: 55px; display: flex; align-items: flex-end; padding-bottom: 10px; }
    .typing-dots { display: inline-flex; gap: 2.7px; vertical-align: middle; align-items: flex-end; }
    .tdot { display: inline-block; width: 7px; height: 7px; background: #bbb; border-radius: 50%; opacity: .7; animation: tdotbounce 1.1s infinite; margin-right: 2px; }
    .tdot1 { animation-delay: 0s;}
    .tdot2 { animation-delay: 0.15s;}
    .tdot3 { animation-delay: 0.33s;}
    @keyframes tdotbounce { 0%,80%,100% { transform: translateY(0); opacity: .66; } 35% { transform: translateY(-7px); opacity: 1;} 50% { opacity: 1;} }
    @media(max-width:650px){ .chat-container { max-width: 99vw; min-width: 0; } #messages { padding: 11px 6px 7px 6px;} .top-bar { height: 44px; } .top-logo { width: 23px; height: 23px; margin: 0 7px 0 7px;} .top-title { font-size: 1.02rem;} .top-sub { font-size: 0.74em; } }
  </style>
</head>
<body>
  <div class="top-bar">
    <img src="https://i.ibb.co/Mk4WpHL9/25-1.png" class="top-logo" alt="logo"/>
    <span>
      <span class="top-title">NEURONA</span>
      <span class="top-sub">Trade AI Bot</span>
    </span>
    <button class="refresh-btn" id="refreshBtn" title="–û–±–Ω–æ–≤–∏—Ç—å">
      <svg viewBox="0 0 24 24" fill="none" stroke-width="2.7">
        <path d="M4 17.5A9 9 0 1021 12" stroke="#181818" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M21 6v6h-6" stroke="#181818" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>
  <div id="app">
    <div class="chat-container">
      <div id="messages"></div>
    </div>
  </div>
  <script>
    // --- PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }
    // --- NOTIFICATION
    if ('Notification' in window && Notification.permission !== "granted") {
      Notification.requestPermission();
    }
    // --- CORE: –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, —Ç–æ—á–∫–∏, —Å–æ–æ–±—â–µ–Ω–∏—è ---
    const messagesEl = document.getElementById('messages');
    const refreshBtn = document.getElementById('refreshBtn');
    let autoRefresh = null;

    function showTyping() {
      const d = document.createElement('div');
      d.className = 'message typing';
      d.innerHTML = `<span class="typing-dots">
        <span class="tdot tdot1"></span>
        <span class="tdot tdot2"></span>
        <span class="tdot tdot3"></span>
      </span>`;
      messagesEl.appendChild(d);
      scrollToBottom();
      return d;
    }

    function addMessage(txt, className = "") {
      const msg = document.createElement('div');
      msg.className = 'message' + (className ? ' ' + className : '');
      if (/long/i.test(txt)) msg.classList.add('long');
      if (/short/i.test(txt)) msg.classList.add('short');
      if (/news/i.test(className)) msg.classList.add('news');
      msg.innerHTML = txt;
      messagesEl.appendChild(msg);
      scrollToBottom();
    }

    function scrollToBottom() {
      messagesEl.scrollTo({top: messagesEl.scrollHeight, behavior: 'smooth'});
    }

    // --- –ü—É–±–ª–∏—á–Ω—ã–µ API: Binance + CoinGecko + CryptoPanic (–Ω–æ–≤–æ—Å—Ç–∏)
    async function fetchBinance() {
      // https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT
      // https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=20
      let price = 0, volume = 0, signal = '', buyVol = 0, sellVol = 0, change = 0, result = '';
      try {
        const ticker = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT').then(r=>r.json());
        price = parseFloat(ticker.lastPrice);
        volume = parseFloat(ticker.volume);
        change = parseFloat(ticker.priceChangePercent);
        // —Å—Ç–∞–∫–∞–Ω—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞
        const depth = await fetch('https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=20').then(r=>r.json());
        buyVol = depth.bids.slice(0,7).reduce((s,b)=>s+parseFloat(b[1]),0);
        sellVol = depth.asks.slice(0,7).reduce((s,b)=>s+parseFloat(b[1]),0);
        let volRatio = buyVol/(sellVol+0.01);
        if (volRatio > 1.15 && change > 0.1) {
          signal = `<b style="color:#00a800">BTC/USDT LONG</b> ‚Äî –û–±—ä—ë–º –ø–æ–∫—É–ø–æ–∫ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø—Ä–æ–¥–∞–∂–∏<br>–í—Ö–æ–¥: <b>${price.toLocaleString()}</b> | 24—á: <b>${change.toFixed(2)}%</b>`;
        } else if (volRatio < 0.88 && change < -0.1) {
          signal = `<b style="color:#d70000">BTC/USDT SHORT</b> ‚Äî –û–±—ä—ë–º –ø—Ä–æ–¥–∞–∂ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ–∫—É–ø–∫–∏<br>–í—Ö–æ–¥: <b>${price.toLocaleString()}</b> | 24—á: <b>${change.toFixed(2)}%</b>`;
        } else {
          signal = `<b>BTC/USDT</b> ‚Äî –ù–µ—Ç —è–≤–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞<br>–í—Ö–æ–¥: <b>${price.toLocaleString()}</b> | 24—á: <b>${change.toFixed(2)}%</b>`;
        }
        result += signal;
        result += `<br><small>–û–±—ä—ë–º –ø–æ–∫—É–ø–æ–∫: ${buyVol.toFixed(2)}, –æ–±—ä—ë–º –ø—Ä–æ–¥–∞–∂: ${sellVol.toFixed(2)}<br>–°—É–º–º–∞—Ä–Ω—ã–π 24—á –æ–±—ä—ë–º: ${volume.toLocaleString()} BTC</small>`;
      } catch(e){
        result = "<b>–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö Binance!</b>";
      }
      return result;
    }

    async function fetchCoinGecko() {
      try {
        const cg = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd,eur&include_24hr_change=true').then(r=>r.json());
        const p = cg.bitcoin.usd;
        const ch = cg.bitcoin.usd_24h_change;
        return `<b>CoinGecko BTC:</b> <b>${p}$</b> (${ch>=0?'<span style="color:green">+'+ch.toFixed(2)+'%</span>':'<span style="color:red">'+ch.toFixed(2)+'%</span>'})`;
      } catch {
        return '';
      }
    }

    async function fetchCryptoPanic() {
      try {
        // –ü—Ä–æ–∫—Å–∏, –∏–Ω–∞—á–µ CORS ‚Äî https://cryptopanic.com/api/v1/posts/?auth_token=2cd2ebe38c9af9d7b50c0c0b9a5d0213e6798ccd&currencies=BTC&public=true
        const url = 'https://api.allorigins.win/raw?url=' + encodeURIComponent('https://cryptopanic.com/api/v1/posts/?auth_token=2cd2ebe38c9af9d7b50c0c0b9a5d0213e6798ccd&currencies=BTC&public=true');
        const r = await fetch(url).then(x=>x.json());
        if (!r.results) return "";
        let out = '<b>üì∞ –ù–æ–≤–æ—Å—Ç–∏ BTC</b><ul>';
        r.results.slice(0,4).forEach(n=>{
          out += `<li><a href="${n.url}" target="_blank">${n.title}</a></li>`;
        });
        out += '</ul>';
        return out;
      } catch {
        return "<b>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π CryptoPanic</b>";
      }
    }

    async function fetchAll() {
      messagesEl.innerHTML = '';
      const typing = showTyping();
      let [binance, cg, news] = await Promise.all([
        fetchBinance(),
        fetchCoinGecko(),
        fetchCryptoPanic()
      ]);
      if (typing && typing.parentNode) typing.parentNode.removeChild(typing);
      addMessage(binance, (binance.includes('LONG') ? 'long' : binance.includes('SHORT') ? 'short' : ''));
      addMessage(cg, '');
      addMessage(news, 'news');
    }

    refreshBtn.onclick = fetchAll;
    function startAuto(){ if (autoRefresh) clearInterval(autoRefresh); autoRefresh = setInterval(fetchAll, 70000);}
    window.onload = () => { fetchAll(); startAuto(); };
  </script>
</body>
</html>
