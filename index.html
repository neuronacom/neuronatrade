<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>NEURONA Trade AI</title>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#fff">
  <link rel="icon" href="/static/logo.png">
  <style>
    html, body {background:#fff; height:100%; margin:0; padding:0;}
    body {font-family: 'Inter', Arial, sans-serif; color:#131313;}
    .header {display:flex; align-items:center; gap:14px; padding:19px 18px 0 22px;}
    .logo {width:40px;}
    .title {font-size:1.25rem; font-weight:700; letter-spacing:.04em;}
    .wrap {max-width:460px;margin:30px auto 0 auto;padding:0 10px;}
    .chat {background:#f6f8fa; border-radius:20px; box-shadow:0 0 24px #0001; min-height:220px; padding:18px 14px; max-height:70vh; overflow:auto;}
    .msg-ai {margin-bottom:19px; border-left:3px solid #00C9A7; padding-left:10px; font-size:1.1em;}
    .msg-news {margin:18px 0 18px 0; font-size:1.12em; line-height:1.5;}
    .section-title {margin:18px 0 11px; font-weight:700; font-size:1.1em;}
    .refresh-btn {position:absolute;top:26px;right:24px; background:0;border:0;cursor:pointer;font-size:1.3em;}
    .notif-popup {position:fixed;left:50%;bottom:45px;transform:translateX(-50%);background:#222;color:#fff;padding:13px 30px;border-radius:23px;font-size:1.1em;z-index:999;opacity:0;pointer-events:none;transition:.25s;}
    .notif-popup.active {opacity:1;pointer-events:auto;}
    @media (max-width:600px){
      .wrap {padding:0 2vw;}
      .chat {max-height:63vh;}
      .header {padding-left:12px;}
    }
  </style>
</head>
<body>
  <div class="header">
    <img class="logo" src="/static/logo.png" alt="logo">
    <span class="title">NEURONA Trade AI</span>
    <button class="refresh-btn" id="refreshBtn">&#8635;</button>
  </div>
  <div class="wrap">
    <div class="chat" id="chat"></div>
  </div>
  <div class="notif-popup" id="notifPopup"></div>
  <script>
    // PWA и разрешение уведомлений
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js');
    }
    document.addEventListener("DOMContentLoaded", ()=>{
      if (window.Notification && Notification.permission !== "granted") {
        Notification.requestPermission().then(function(permission) {
          if(permission === "granted") showNotif("Уведомления активированы!");
        });
      }
    });
    function showNotif(txt) {
      let el=document.getElementById('notifPopup');
      el.textContent=txt;
      el.classList.add('active');
      setTimeout(()=>el.classList.remove('active'),2300);
    }

    const chat = document.getElementById('chat');
    function msgAI(text){ chat.innerHTML+=`<div class="msg-ai">${text}</div>`; }
    function msgNews(news){
      news.forEach(n=>{
        let txt = n.title;
        if(n.desc) txt += "<br><i>"+n.desc+"</i>";
        let t = n.published_at ? n.published_at : "";
        chat.innerHTML+=`<div class="msg-news">${txt}<span style="color:#aaa;float:right">${t}</span></div>`;
      });
    }
    function msgSection(title){ chat.innerHTML+=`<div class="section-title">${title}</div>`; }

    // Только одна новость и сигнал по ней!
    async function loadAll(){
      chat.innerHTML="";
      msgSection("BTC/USDT — новость");
      const d = await fetch("/api/data").then(r=>r.json());
      if(d.news && d.news.length) msgNews(d.news);
      else msgAI("<i>Новость временно недоступна.</i>");
      msgSection("AI сигнал");
      msgAI("<i>Генерируем...</i>");
      fetch("/api/signal").then(r=>r.json()).then(sig=>{
        chat.innerHTML+=`<div class="msg-ai"><b>${sig.signal.replace(/\n/g,'<br>')}</b></div>`;
        showNotif("Сигнал BTC обновлён!");
        if(Notification.permission==="granted") {
          new Notification("NEURONA AI BTC Сигнал", { body: sig.signal.replace(/\n/g,' ') });
        }
      });
    }
    document.getElementById('refreshBtn').onclick=loadAll;
    loadAll();
    setInterval(loadAll, 60*1000);
  </script>
</body>
</html>
