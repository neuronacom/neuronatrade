<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>NEURONA Trade AI</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f7f8fa">
  <link rel="icon" type="image/png" href="https://i.ibb.co/XfKRzvcy/27.png">
  <style>
    html,body{
      height:100%;
      margin:0;
      padding:0;
      background:#f7f8fa;
      font-family:'Segoe UI',Arial,sans-serif;
      color:#111;
      overscroll-behavior:none;
      width:100vw;
      max-width:100vw;
      overflow-x:hidden;
    }
    body{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      width:100vw;
      max-width:100vw;
      overflow-x:hidden;
    }
    .wrap{
      width:100vw;
      max-width:430px;
      min-height:100vh;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:center;
      background:#f7f8fa;
      margin:0 auto;
      padding:0;
      position:relative;
      overflow-x:hidden;
    }
    .topbar{
      width:100%;
      max-width:430px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:19px 13px 13px 13px;
      background:#f7f8fa;
      position:sticky;
      top:0;
      z-index:5;
      border-bottom:1px solid #eee;
      box-sizing:border-box;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      font-size:1.20rem;
      letter-spacing:0.05em;
      color:#222;
      white-space:nowrap;
    }
    .logo img{
      width:33px;
      height:33px;
      border-radius:9px;
      margin-right:6px;
      vertical-align:middle;
      background:#fafafa;
    }
    .bell{
      cursor:pointer;
      width:30px;
      height:30px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:50%;
      transition:background .2s;
      position:relative;
      background:transparent;
      margin-right:2px;
    }
    .bell img{
      width:22px;
      height:22px;
      display:block;
      opacity:1;
      transition:opacity .2s;
    }
    .bell.bell-off img{
      opacity:0.33;
    }
    .bell:hover{background:#ececec;}
    .main{
      width:100vw;
      max-width:430px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:#f7f8fa;
      min-height:560px;
      margin:0 auto;
      box-sizing:border-box;
      align-items:center;
      justify-content:flex-start;
      padding-bottom:16px;
    }
    .signals-box, .news-box{
      width:95vw;
      max-width:410px;
      margin:0 auto 7px auto;
      background:#fff;
      border-radius:18px;
      box-shadow:0 1px 6px #0001;
      padding:0 0 3px 0;
      box-sizing:border-box;
      overflow-x:hidden;
      position:relative;
    }
    .signals-box{
      height:210px;
      overflow-y:auto;
      margin-bottom:7px;
    }
    .news-box{
      height:160px;
      overflow-y:auto;
    }
    .signal-msg{
      width:96%;
      margin:9px auto 7px auto;
      background:#f5f7fb;
      border-radius:12px;
      box-shadow:0 1px 3px #0001;
      padding:11px 12px 13px 12px;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      font-size:1.07rem;
      line-height:1.6;
      word-break:break-word;
      color:#1b2433;
    }
    .signal-type{
      font-weight:700;
      text-transform:uppercase;
      font-size:1.04em;
      margin-bottom:2px;
      color:#2094e6;
    }
    .signal-msg .time{
      color:#a5a5a5;
      font-size:0.94em;
      position:absolute;
      right:19px;
      bottom:7px;
      margin:0;
      padding:0;
      font-weight:400;
    }
    .news-msg{
      width:96%;
      margin:0 auto 8px auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:7px;
      padding:10px 10px 10px 9px;
      border-radius:12px;
      background:#f7fafc;
      font-size:1.02rem;
      line-height:1.45;
      word-break:break-word;
    }
    .news-title{
      color:#2578e5;
      text-decoration:none;
      font-weight:500;
      font-size:1.03em;
      cursor:pointer;
      transition:color .19s;
      flex:1;
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
      max-width:280px;
    }
    .news-title:hover{
      color:#0d3dc6;
      text-decoration:underline;
    }
    .news-msg .time{
      color:#b0b0b0;
      font-size:0.98em;
      min-width:41px;
      text-align:right;
      font-weight:400;
      margin-left:5px;
    }
    .notif-popup{
      position:fixed;
      left:50%;
      bottom:36px;
      transform:translateX(-50%);
      min-width:145px;
      background:#202020;
      color:#fff;
      font-size:1.01em;
      border-radius:16px;
      padding:11px 24px;
      z-index:50;
      text-align:center;
      opacity:0;
      pointer-events:none;
      transition:opacity .32s;
    }
    .notif-popup.show{
      opacity:1;
      pointer-events:auto;
    }
    @media (max-width:500px){
      .wrap, .main, .topbar, .signals-box, .news-box{
        max-width:100vw;
        width:100vw;
      }
      .signal-msg, .news-msg{
        width:97vw;
      }
      .signals-box{height:31vh;}
      .news-box{height:18vh;}
    }
    @media (max-width:400px){
      .signal-msg, .news-msg{font-size:0.97rem;}
      .signals-box, .news-box{max-width:99vw;}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="logo">
      <img src="https://i.ibb.co/XfKRzvcy/27.png" alt="N">
      NEURONA Trade AI
    </div>
    <div class="bell bell-off" id="notifBell" title="Включить уведомления">
      <img src="/static/bell.png" alt="Bell" width="22" height="22" id="bellIcon"/>
    </div>
  </div>
  <div class="main">
    <div class="signals-box" id="signalsBox"></div>
    <div class="news-box" id="newsBox"></div>
  </div>
</div>
<div class="notif-popup" id="notifPopup"></div>
<script>
let notificationEnabled = false;
const bell = document.getElementById('notifBell');
const notifPopup = document.getElementById('notifPopup');
const bellIcon = document.getElementById('bellIcon');
function showPopup(msg){
  notifPopup.textContent = msg;
  notifPopup.classList.add('show');
  setTimeout(()=>notifPopup.classList.remove('show'),2100);
}
function toggleBell(active){
  notificationEnabled = !!active;
  bell.classList.toggle('bell-off',!active);
  bellIcon.style.opacity = active?'1':'0.4';
}
bell.onclick = async function(){
  if(notificationEnabled){
    toggleBell(false);
    showPopup('Уведомления выключены');
    return;
  }
  if('Notification' in window){
    if(Notification.permission==='granted'){
      toggleBell(true);showPopup('Уведомления включены!');
    }else if(Notification.permission!=='denied'){
      let perm=await Notification.requestPermission();
      if(perm==='granted'){toggleBell(true);showPopup('Уведомления включены!');}
      else{showPopup('Разрешение не получено');}
    }else{
      showPopup('Уведомления заблокированы в браузере');
    }
  }else{showPopup('Браузер не поддерживает уведомления');}
};
window.addEventListener('load',()=>{
  if('Notification' in window && Notification.permission==='granted') toggleBell(true);
  else toggleBell(false);
});
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js');
}
function pushNotification(title,body){
  if(notificationEnabled && 'Notification' in window && Notification.permission==='granted'){
    new Notification(title,{body,icon:"https://i.ibb.co/XfKRzvcy/27.png"});
  }
}
const signalsBox = document.getElementById('signalsBox');
const newsBox = document.getElementById('newsBox');
let lastSignalId=0,lastNewsId=0;
async function fetchSignalsNews(manual){
  try{
    const res = await fetch('/api/all');
    const data = await res.json();
    // SIGS
    signalsBox.innerHTML = '';
    if(data.signals && Array.isArray(data.signals)){
      data.signals.forEach(sig=>{
        let t = `<div class="signal-msg">
          <div class="signal-type">${sig.type}</div>
          <div>${sig.text}</div>
          <div class="time">${sig.time}</div>
        </div>`;
        signalsBox.insertAdjacentHTML('beforeend',t);
      });
      if(data.signals.length && data.signals[data.signals.length-1].id!=lastSignalId){
        lastSignalId = data.signals[data.signals.length-1].id;
        if(!manual) pushNotification('AI-сигнал BTC',data.signals[data.signals.length-1].type+': '+data.signals[data.signals.length-1].text);
      }
    }
    // NEWS
    newsBox.innerHTML = '';
    if(data.news && Array.isArray(data.news)){
      data.news.forEach(n=>{
        let t = `<div class="news-msg">
          <a class="news-title" href="${n.url}" target="_blank">${n.title}</a>
          <span class="time">${n.time}</span>
        </div>`;
        newsBox.insertAdjacentHTML('beforeend',t);
      });
      if(data.news.length && data.news[data.news.length-1].id!=lastNewsId){
        lastNewsId = data.news[data.news.length-1].id;
        if(!manual) pushNotification('Крипто-новость',data.news[data.news.length-1].title);
      }
    }
  }catch(e){
    showPopup('Ошибка загрузки');
  }
}
setInterval(()=>fetchSignalsNews(false),37000);
fetchSignalsNews(false);
</script>
</body>
</html>
