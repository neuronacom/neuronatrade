<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=420,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>NEURONA Trade AI</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#fff">
  <style>
    html,body{
      height:100%;margin:0;padding:0;background:#fff;
      font-family:'Segoe UI',Arial,sans-serif;color:#111;
      width:100vw;max-width:100vw;overflow:hidden;
    }
    body{
      min-height:100vh;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
      background:#fff;width:100vw;max-width:100vw;overflow:hidden;
    }
    .wrap{
      width:375px;max-width:100vw;min-height:100vh;
      box-sizing:border-box;display:flex;flex-direction:column;
      justify-content:flex-start;align-items:center;
      background:#fff;margin:0 auto;padding:0;position:relative;
      overflow:hidden;
    }
    .topbar{
      width:100%;max-width:375px;margin:0 auto;
      display:flex;align-items:center;justify-content:space-between;
      padding:17px 10px 10px 8px;
      background:#fff;position:sticky;top:0;z-index:4;
      border-bottom:1px solid #eee;box-sizing:border-box;
    }
    .logo{
      display:flex;align-items:center;gap:12px;
      font-weight:700;font-size:1.12rem;letter-spacing:0.05em;color:#222;white-space:nowrap;
    }
    .logo img{width:32px;height:32px;border-radius:8px;margin-right:5px;vertical-align:middle;background:#fafafa;}
    .bell{cursor:pointer;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background .2s;position:relative;}
    .bell img{width:22px;height:22px;display:block;opacity:1;transition:opacity .2s;}
    .bell.bell-off img{opacity:0.4;}
    .bell:hover{background:#f3f3f3;}
    .main{
      flex:1 1 0;width:100%;max-width:375px;
      display:flex;flex-direction:column;gap:0;background:#fff;
      min-height:420px;position:relative;margin:0 auto;box-sizing:border-box;
      overflow:hidden;align-items:center;justify-content:flex-start;
    }
    .signals-box{
      width:100%;max-width:375px;height:160px;background:#fff;flex:0 0 auto;
      display:flex;flex-direction:column;align-items:center;justify-content:flex-end;
      overflow-y:auto;overflow-x:hidden;margin-bottom:10px;box-sizing:border-box;
      border-bottom:1px solid #f1f1f1;scroll-behavior:smooth;
    }
    .signal-msg{
      width:95%;margin:6px auto 6px auto;background:#fafbfc;
      border-radius:14px;box-shadow:0 1px 3px #0001;
      padding:11px 13px 11px 13px;display:flex;flex-direction:column;
      align-items:flex-start;font-size:1.03rem;line-height:1.6;
      word-break:break-word;position:relative;color:#192e43;
    }
    .signal-type{font-weight:700;text-transform:uppercase;font-size:1em;margin-bottom:2px;}
    .signal-type.LONG{color:#13b05b;}
    .signal-type.SHORT{color:#e94444;}
    .signal-type.HODL{color:#a5a5a5;}
    .signal-msg .time{color:#a5a5a5;font-size:0.95em;position:absolute;right:15px;bottom:9px;margin:0;padding:0;font-weight:400;}
    .news-box{
      width:100%;max-width:375px;height:120px;display:flex;flex-direction:column;
      align-items:center;overflow-y:auto;background:#fff;padding:0 0 7px 0;
      margin:0 auto;box-sizing:border-box;overflow-x:hidden;
    }
    .news-msg{
      width:95%;margin:0 auto 7px auto;display:flex;align-items:center;justify-content:space-between;
      gap:10px;padding:8px 8px 8px 10px;border-radius:11px;background:#f6f8fc;
      font-size:0.97rem;line-height:1.35;word-break:break-word;
    }
    .news-title{color:#1671e6;text-decoration:none;font-weight:500;font-size:1em;word-break:break-word;cursor:pointer;transition:color .19s;}
    .news-title:hover{color:#0d3dc6;text-decoration:underline;}
    .news-msg .time{color:#b0b0b0;font-size:0.96em;min-width:39px;text-align:right;font-weight:400;margin-left:7px;}
    .notif-popup{position:fixed;left:50%;bottom:34px;transform:translateX(-50%);min-width:140px;background:#202020;color:#fff;font-size:1em;border-radius:13px;padding:11px 19px;z-index:10;text-align:center;opacity:0;pointer-events:none;transition:opacity .34s;}
    .notif-popup.show{opacity:1;pointer-events:auto;}
    @media (max-width:400px){
      .wrap, .main, .topbar, .signals-box, .news-box{max-width:100vw;width:100vw;}
      .signal-msg, .news-msg{width:97vw;}
      .signals-box{height:27vh;}
      .news-box{height:15vh;}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="logo">
      <img src="https://i.ibb.co/XfKRzvcy/27.png" alt="N">
      NEURONA Trade AI
    </div>
    <div class="bell bell-off" id="notifBell" title="Включить уведомления">
      <img src="/static/bell.png" alt="Bell" width="22" height="22" id="bellIcon"/>
    </div>
  </div>
  <div class="main">
    <div class="signals-box" id="signalsBox"></div>
    <div class="news-box" id="newsBox"></div>
  </div>
</div>
<div class="notif-popup" id="notifPopup"></div>
<script>
let notificationEnabled = false;
const bell = document.getElementById('notifBell');
const notifPopup = document.getElementById('notifPopup');
const bellIcon = document.getElementById('bellIcon');
function showPopup(msg){
  notifPopup.textContent = msg;
  notifPopup.classList.add('show');
  setTimeout(()=>notifPopup.classList.remove('show'),2400);
}
function toggleBell(active){
  notificationEnabled = !!active;
  bell.classList.toggle('bell-off',!active);
  bellIcon.style.opacity = active?'1':'0.4';
}
bell.onclick = async function(){
  if(notificationEnabled){
    toggleBell(false);showPopup('Уведомления выключены');
    return;
  }
  if('Notification' in window){
    if(Notification.permission==='granted'){
      toggleBell(true);showPopup('Уведомления включены!');
    }else if(Notification.permission!=='denied'){
      let perm=await Notification.requestPermission();
      if(perm==='granted'){toggleBell(true);showPopup('Уведомления включены!');}
      else{showPopup('Разрешение не получено');}
    }else{
      showPopup('Уведомления заблокированы в браузере');
    }
  }else{showPopup('Браузер не поддерживает уведомления');}
};
window.addEventListener('load',()=>{
  if('Notification' in window && Notification.permission==='granted') toggleBell(true);
  else toggleBell(false);
});
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js');
}
function pushNotification(title,body){
  if(notificationEnabled && 'Notification' in window && Notification.permission==='granted'){
    new Notification(title,{body,icon:"https://i.ibb.co/XfKRzvcy/27.png"});
  }
}
const signalsBox = document.getElementById('signalsBox');
const newsBox = document.getElementById('newsBox');
let lastSignalId=0,lastNewsId=0;
async function fetchSignalsNews(manual){
  try{
    const res = await fetch('/api/all');
    const data = await res.json();
    // SIGS
    signalsBox.innerHTML = '';
    if(data.signals && Array.isArray(data.signals)){
      data.signals.forEach(sig=>{
        let t = `<div class="signal-msg">
          <div class="signal-type ${sig.type}">${sig.type}</div>
          <div>${sig.text}</div>
          <div class="time">${sig.time}</div>
        </div>`;
        signalsBox.insertAdjacentHTML('beforeend',t);
      });
      if(data.signals.length && data.signals[data.signals.length-1].id!=lastSignalId){
        lastSignalId = data.signals[data.signals.length-1].id;
        pushNotification('Крипто-сигнал',data.signals[data.signals.length-1].type+': '+data.signals[data.signals.length-1].text);
      }
    }
    // NEWS
    newsBox.innerHTML = '';
    if(data.news && Array.isArray(data.news)){
      data.news.forEach(n=>{
        let t = `<div class="news-msg">
          <a class="news-title" href="${n.url}" target="_blank">${n.title}</a>
          <span class="time">${n.time}</span>
        </div>`;
        newsBox.insertAdjacentHTML('beforeend',t);
      });
      if(data.news.length && data.news[data.news.length-1].id!=lastNewsId){
        lastNewsId = data.news[data.news.length-1].id;
        pushNotification('Крипто-новость',data.news[data.news.length-1].title);
      }
    }
  }catch(e){
    showPopup('Ошибка загрузки');
  }
}
setInterval(()=>fetchSignalsNews(false),20000);
fetchSignalsNews(false);
</script>
</body>
</html>
