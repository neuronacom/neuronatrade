<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>NEURONA Trade AI</title>
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#fff">
  <link rel="icon" href="/static/logo.png">
  <style>
    html, body {background:#fff; height:100%; margin:0; padding:0;}
    body {font-family: 'Inter', Arial, sans-serif; color:#131313;}
    .header {display:flex; align-items:center; gap:14px; padding:19px 18px 0 22px;}
    .logo {width:40px;}
    .title {font-size:1.25rem; font-weight:700; letter-spacing:.04em;}
    .wrap {max-width:460px;margin:30px auto 0 auto;padding:0 10px;}
    .chat {background:#f6f8fa; border-radius:20px; box-shadow:0 0 24px #0001; min-height:350px; padding:18px 14px; max-height:70vh; overflow:auto;}
    .msg-ai {margin-bottom:19px; border-left:3px solid #00C9A7; padding-left:10px; font-size:1.1em;}
    .msg-news {margin:9px 0 13px 0;}
    .msg-user {color:#aaa;}
    .section-title {margin:21px 0 12px; font-weight:700; font-size:1.08em;}
    .refresh-btn {position:absolute;top:26px;right:24px; background:0;border:0;cursor:pointer;font-size:1.3em;}
    .notif-popup {position:fixed;left:50%;bottom:45px;transform:translateX(-50%);background:#222;color:#fff;padding:13px 30px;border-radius:23px;font-size:1.1em;z-index:999;opacity:0;pointer-events:none;transition:.25s;}
    .notif-popup.active {opacity:1;pointer-events:auto;}
    @media (max-width:600px){
      .wrap {padding:0 2vw;}
      .chat {max-height:63vh;}
      .header {padding-left:12px;}
    }
  </style>
</head>
<body>
  <div class="header">
    <img class="logo" src="/static/logo.png" alt="logo">
    <span class="title">NEURONA Trade AI</span>
    <button class="refresh-btn" id="refreshBtn">&#8635;</button>
  </div>
  <div class="wrap">
    <div class="chat" id="chat"></div>
  </div>
  <div class="notif-popup" id="notifPopup"></div>
  <script>
    // PWA –∏ –∑–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/sw.js');
    }
    document.addEventListener("DOMContentLoaded", ()=>{
      if (window.Notification && Notification.permission !== "granted") {
        Notification.requestPermission().then(function(permission) {
          if(permission === "granted") showNotif("–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã!");
        });
      }
    });
    function showNotif(txt) {
      let el=document.getElementById('notifPopup');
      el.textContent=txt;
      el.classList.add('active');
      setTimeout(()=>el.classList.remove('active'),2300);
    }

    // Safe value getter –¥–ª—è —Å—Ç–∞–∫–∞–Ω–∞ (–∏ –≤—Å–µ–≥–æ –º–∞—Å—Å–∏–≤–∞)
    function safeVal(arr, idx1=0, idx2=0) {
      return (arr && arr.length > 0 && arr[idx1] && arr[idx1][idx2]) ? arr[idx1][idx2] : "-";
    }

    const chat = document.getElementById('chat');
    function msgAI(text){ chat.innerHTML+=`<div class="msg-ai">${text}</div>`; }
    function msgNews(news){
      news.forEach(n=>{
        let href = n.url ? n.url : "#";
        chat.innerHTML+=`<div class="msg-news"><b>üì∞ <a href="${href}" target="_blank">${n.title}</a></b> <span style="color:#aaa;font-size:.95em;">${n.published_at ? n.published_at.slice(11,16) : ""}</span></div>`;
      });
    }
    function msgSection(title){ chat.innerHTML+=`<div class="section-title">${title}</div>`; }

    // –î–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
    async function loadAll(){
      chat.innerHTML="";
      msgSection("–ê–∫—Ç—É–∞–ª—å–Ω—ã–π BTC –∞–Ω–∞–ª–∏–∑");
      msgAI("<i>–û–±–Ω–æ–≤–ª—è–µ–º...</i>");
      const d = await fetch("/api/data").then(r=>r.json());
      chat.innerHTML = "";
      msgSection("BTC/USDT ‚Äî —Å—Ç–∞–∫–∞–Ω –∏ –æ–±—ä—ë–º—ã");
      msgAI(`
        <b>–¶–µ–Ω–∞:</b> $${d.btc && d.btc.lastPrice ? d.btc.lastPrice : "-"}<br>
        <b>24—á –æ–±—ä—ë–º:</b> ${d.btc && d.btc.volume ? Number(d.btc.volume).toLocaleString() : "-"} BTC<br>
        <b>–ò–∑–º–µ–Ω–µ–Ω–∏–µ 24—á:</b> ${d.btc && d.btc.priceChangePercent ? d.btc.priceChangePercent : "-"}%<br>
        <b>–í–µ—Ä—Ö —Å—Ç–∞–∫–∞–Ω–∞:</b> ${safeVal(d.btc && d.btc.asks ? d.btc.asks : [])}<br>
        <b>–ù–∏–∑ —Å—Ç–∞–∫–∞–Ω–∞:</b> ${safeVal(d.btc && d.btc.bids ? d.btc.bids : [])}
      `);
      msgSection("–ù–æ–≤–æ—Å—Ç–∏ –ø–æ BTC");
      if(d.news && d.news.length) msgNews(d.news);
      else msgAI("<i>–ù–æ–≤–æ—Å—Ç–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.</i>");
      msgSection("AI —Å–∏–≥–Ω–∞–ª");
      msgAI("<i>–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º...</i>");
      fetch("/api/signal").then(r=>r.json()).then(sig=>{
        chat.innerHTML+=`<div class="msg-ai"><b>${sig.signal.replace(/\n/g,'<br>')}</b></div>`;
        showNotif("–û–±–Ω–æ–≤–ª–µ–Ω–æ! –°–∏–≥–Ω–∞–ª BTC –≥–æ—Ç–æ–≤.");
        if(Notification.permission==="granted") {
          new Notification("NEURONA AI BTC –°–∏–≥–Ω–∞–ª", { body: sig.signal.replace(/\n/g,' ') });
        }
      });
    }
    document.getElementById('refreshBtn').onclick=loadAll;
    loadAll();
    setInterval(loadAll, 5*60*1000);
  </script>
</body>
</html>
