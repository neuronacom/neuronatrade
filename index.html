<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>NEURONA Trade AI</title>
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="icon" href="https://i.ibb.co/XfKRzvcy/27.png" />
  <style>
    body {
      margin: 0; padding: 0;
      background: #fff;
      font-family: Arial, sans-serif;
      color: #000;
    }
    #top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 18px;
      background: #f5f5f5;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    #top-title {
      display: flex;
      flex-direction: column;
    }
    #top-title h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: .1em;
      font-weight: bold;
    }
    #top-title h2 {
      margin: 0;
      font-size: 0.9rem;
      color: #555;
    }
    #refreshBtn {
      background: none;
      border: none;
      font-size: 1.6rem;
      cursor: pointer;
      color: #000;
    }
    #content {
      padding: 14px;
      max-width: 420px;
      margin: 0 auto;
    }
    .msg {
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      font-size: 1rem;
      line-height: 1.5;
      position: relative;
    }
    .msg.long {
      background: #e7f9e7;
      border: 1px solid #54c154;
      color: #2a672a;
    }
    .msg.short {
      background: #fde6e6;
      border: 1px solid #e05858;
      color: #a82828;
    }
    .msg.news {
      background: #f0f0f0;
      border: 1px solid #ccc;
    }
    .msg.typing {
      font-style: italic;
      color: #777;
    }
    .time {
      font-size: 0.75rem;
      color: #777;
      margin-top: 4px;
      display: block;
    }
  </style>
</head>
<body>
  <div id="top">
    <div id="top-title">
      <h1>NEURONA</h1>
      <h2>Trade AI</h2>
    </div>
    <button id="refreshBtn" title="–û–±–Ω–æ–≤–∏—Ç—å">&#x21bb;</button>
  </div>
  <div id="content"></div>

  <script>
    const content = document.getElementById("content");
    const refreshBtn = document.getElementById("refreshBtn");

    function addMsg(text, type) {
      const div = document.createElement("div");
      div.className = "msg " + type;
      div.innerHTML = text + `<div class="time">${new Date().toLocaleTimeString().slice(0,5)}</div>`;
      content.appendChild(div);
      content.scrollTop = content.scrollHeight;
    }

    async function loadSignals() {
      addMsg("‚è≥ –ü–æ–ª—É—á–∞—é —Å–∏–≥–Ω–∞–ª...", "typing");
      try {
        const res = await fetch("/api/signals");
        const data = await res.json();
        content.querySelector(".typing")?.remove();
        if (data.long) addMsg("üü¢ <b>LONG:</b> " + data.long, "long");
        else if (data.short) addMsg("üî¥ <b>SHORT:</b> " + data.short, "short");
        else addMsg("–ù–µ—Ç —Å–∏–≥–Ω–∞–ª–∞ —Å–µ–π—á–∞—Å", "news");
      } catch {
        content.querySelector(".typing")?.remove();
        addMsg("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–∞", "short");
      }
    }

    async function loadNews() {
      try {
        const res = await fetch("/api/news");
        const news = await res.json();
        news.slice(0, 3).forEach(n =>
          addMsg(`üì∞ <b>${n.title}</b><br><a href="${n.url}" target="_blank">${n.url}</a>`, "news")
        );
      } catch {
        addMsg("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏", "news");
      }
    }

    async function updateAll() {
      await loadSignals();
      await loadNews();
    }

    refreshBtn.onclick = updateAll;

    // –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    updateAll();
    setInterval(updateAll, 60_000);

    // PWA –∏ –ø—É—à
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/sw.js");
    }

    Notification.requestPermission().then(res => {
      if (res === "granted") {
        console.log("üîî Push —Ä–∞–∑—Ä–µ—à–µ–Ω—ã");
      }
    });
  </script>
</body>
</html>
